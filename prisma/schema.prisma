generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

model Site {
  id             String          @id @default(cuid())
  name           String          @unique
  users          User[]
  departments    Department[]
  securityEvents SecurityEvent[]
  trustedIps     TrustedIp[]
  createdAt      DateTime        @default(now())
}

model Department {
  id             String           @id @default(cuid())
  siteId         String
  name           String
  site           Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  users          User[]
  ratingCriteria RatingCriteria[]
  createdAt      DateTime         @default(now())

  @@unique([siteId, name])
  @@index([siteId])
}

model User {
  id                 String   @id @default(cuid())
  siteId             String
  departmentId       String?
  role               UserRole @default(STAFF)
  name               String
  email              String   @unique
  avatarKey          String?
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true)
  createdByUserId    String?

  site       Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  createdBy    User?  @relation("UserCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("UserCreatedBy")

  passwordCredential PasswordCredential?
  security           UserSecurity?
  sessions           Session[]
  securityEvents     SecurityEvent[]
  createdAt          DateTime            @default(now())

  @@index([siteId])
  @@index([departmentId])
}

model PasswordCredential {
  userId        String   @id
  passwordHash  String
  passwordSetAt DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSecurity {
  userId                   String   @id
  twoFactorEnabled         Boolean  @default(false)
  twoFactorSecretEncrypted String?
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id                    String    @id @default(cuid())
  userId                String
  ip                    String
  deviceLabel           String?
  deviceFingerprintHash String
  createdAt             DateTime  @default(now())
  lastSeenAt            DateTime  @default(now())
  revokedAt             DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ip])
}

model SecurityEvent {
  id         String    @id @default(cuid())
  siteId     String
  userId     String?
  type       String
  metaJson   Json
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  resolvedBy String?

  site Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([userId])
}

model TrustedIp {
  id         String   @id @default(cuid())
  siteId     String
  ipCidrOrIp String
  note       String?
  createdAt  DateTime @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
}

model RatingCriteria {
  id           String   @id @default(cuid())
  departmentId String
  name         String
  weight       Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([departmentId, name])
  @@index([departmentId])
}
