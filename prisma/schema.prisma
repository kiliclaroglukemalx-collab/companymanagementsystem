generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

model Site {
  id              String            @id @default(cuid())
  name            String            @unique
  users           User[]
  departments     Department[]
  securityEvents  SecurityEvent[]
  trustedIps      TrustedIp[]
  arenaEvents     ArenaEvent[]
  ratings         Rating[]
  monthlyScores   MonthlyScore[]
  leagueRankings  LeagueRanking[]
  monthlyChampions MonthlyChampion[]
  dataUploads     DataUpload[]
  financialFlows  FinancialFlow[]
  aiAnalyses      AIAnalysis[]
  targetedAnnouncements Announcement[] @relation("AnnouncementTargetSite")
  createdAt       DateTime          @default(now())
}

model Department {
  id              String            @id @default(cuid())
  siteId          String
  name            String
  site            Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  users           User[]
  ratingCriteria  RatingCriteria[]
  ratings         Rating[]
  monthlyScores   MonthlyScore[]
  leagueRankings  LeagueRanking[]
  monthlyChampions MonthlyChampion[]
  targetedAnnouncements Announcement[] @relation("AnnouncementTargetDepartment")
  createdAt       DateTime          @default(now())

  @@unique([siteId, name])
  @@index([siteId])
}

model User {
  id                 String   @id @default(cuid())
  siteId             String
  departmentId       String?
  role               UserRole @default(STAFF)
  name               String
  email              String   @unique
  avatarKey          String?
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true)
  createdByUserId    String?

  site       Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  createdBy    User?  @relation("UserCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("UserCreatedBy")

  passwordCredential PasswordCredential?
  security           UserSecurity?
  sessions           Session[]
  securityEvents     SecurityEvent[]
  ratingsGiven       Rating[]            @relation("RatingsGiven")
  ratingsReceived    Rating[]            @relation("RatingsReceived")
  monthlyScores      MonthlyScore[]
  leagueRankings     LeagueRanking[]
  monthlyChampions   MonthlyChampion[]
  requestsMade       Request[]           @relation("RequestedBy")
  requestsToApprove  Request[]           @relation("Approver")
  salary             UserSalary?
  createdAt          DateTime            @default(now())

  @@index([siteId])
  @@index([departmentId])
}

model PasswordCredential {
  userId        String   @id
  passwordHash  String
  passwordSetAt DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSecurity {
  userId                   String   @id
  twoFactorEnabled         Boolean  @default(false)
  twoFactorSecretEncrypted String?
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id                    String    @id @default(cuid())
  userId                String
  ip                    String
  deviceLabel           String?
  deviceFingerprintHash String
  createdAt             DateTime  @default(now())
  lastSeenAt            DateTime  @default(now())
  revokedAt             DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ip])
}

model SecurityEvent {
  id         String    @id @default(cuid())
  siteId     String
  userId     String?
  type       String
  metaJson   Json
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  resolvedBy String?

  site Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([userId])
}

model TrustedIp {
  id         String   @id @default(cuid())
  siteId     String
  ipCidrOrIp String
  note       String?
  createdAt  DateTime @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
}

model RatingCriteria {
  id           String        @id @default(cuid())
  departmentId String
  name         String
  weight       Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  department   Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  ratingScores RatingScore[]

  @@unique([departmentId, name])
  @@index([departmentId])
}

// Günlük puanlama kaydı
model Rating {
  id           String        @id @default(cuid())
  siteId       String
  departmentId String
  raterUserId  String        // Puan veren
  ratedUserId  String        // Puan alan
  date         String        // YYYY-MM-DD format
  totalScore   Float?        // Toplam puan (hesaplanmış)
  createdAt    DateTime      @default(now())

  site         Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department   Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  rater        User          @relation("RatingsGiven", fields: [raterUserId], references: [id], onDelete: Cascade)
  rated        User          @relation("RatingsReceived", fields: [ratedUserId], references: [id], onDelete: Cascade)
  scores       RatingScore[]

  @@unique([raterUserId, ratedUserId, date]) // Aynı gün aynı kişiyi 2 kere puanlayamaz
  @@index([siteId])
  @@index([departmentId])
  @@index([date])
  @@index([ratedUserId])
}

// Kriter bazlı puanlar
model RatingScore {
  id         String   @id @default(cuid())
  ratingId   String
  criteriaId String
  score      Int      // 1-10 arası
  createdAt  DateTime @default(now())

  rating   Rating         @relation(fields: [ratingId], references: [id], onDelete: Cascade)
  criteria RatingCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@index([ratingId])
  @@index([criteriaId])
}

// Arena Live Feed Events
enum ArenaEventType {
  RATING_GIVEN
  LEADER_CHANGED
  RATING_PROGRESS
  SECURITY_ALERT
  USER_CREATED
  USER_JOINED
}

model ArenaEvent {
  id        String         @id @default(cuid())
  siteId    String
  type      ArenaEventType
  title     String
  message   String?
  metaJson  Json?
  createdAt DateTime       @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, createdAt(sort: Desc)])
  @@index([type])
}

// Arena Lig Kategorileri
enum LeagueCategory {
  USTAT          // %1
  ELMAS_1        // %1-5
  ELMAS_2        // %5-10
  ALTIN_1        // %10-20
  ALTIN_2        // %20-30
  GUMUS_1        // %30-40
  GUMUS_2        // %40-50
  BRONZ_1        // %50-60
  BRONZ_2        // %60-70
  DEMIR          // %70+
}

// Kullanıcı Tipi (Personel, Admin, Birim Müdürü, Genel Müdür)
enum PersonelType {
  PERSONEL
  ADMIN
  BIRIM_MUDURU
  GENEL_MUDUR
}

// Aylık kümülatif puanlama - Her ay sıfırlanır
model MonthlyScore {
  id           String      @id @default(cuid())
  userId       String
  siteId       String
  departmentId String
  personelType PersonelType @default(PERSONEL)
  month        String      // YYYY-MM format
  totalScore   Float       @default(0)
  ratingCount  Int         @default(0)
  lastRatedAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([siteId, month])
  @@index([departmentId, month])
  @@index([personelType, month])
}

// Lig sıralaması - Her gün hesaplanır
model LeagueRanking {
  id           String         @id @default(cuid())
  userId       String
  siteId       String
  departmentId String
  personelType PersonelType   @default(PERSONEL)
  month        String         // YYYY-MM format
  category     LeagueCategory
  rank         Int            // Kategori içinde sıra
  totalScore   Float
  percentage   Float          // Yüzdelik dilim
  updatedAt    DateTime       @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, month, personelType])
  @@index([siteId, month])
  @@index([category, month])
  @@index([personelType, month])
}

// Ay sonu şampiyonları - Arşiv
model MonthlyChampion {
  id           String         @id @default(cuid())
  userId       String
  siteId       String
  departmentId String
  personelType PersonelType
  month        String         // YYYY-MM format
  category     LeagueCategory
  rank         Int            // Kategori içinde kaçıncı
  totalScore   Float
  createdAt    DateTime       @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([userId, month, personelType])
  @@index([siteId, month])
  @@index([category, month])
}

// Veri Yükleme Merkezi - Data Upload Types
enum DataFileType {
  EXCEL
  CSV
  JSON
}

enum AnalyticModule {
  FINANS
  SPOR
  BON
  CASINO
  GENEL
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Veri Yükleme Kaydı
model DataUpload {
  id              String          @id @default(cuid())
  siteId          String
  uploadedByEmail String
  fileName        String
  fileType        DataFileType
  analyticModule  AnalyticModule
  fileSize        Int
  status          UploadStatus    @default(PENDING)
  processedAt     DateTime?
  errorMessage    String?
  metaData        Json?           // Extra data from upload
  createdAt       DateTime        @default(now())
  
  site            Site            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  financialFlows  FinancialFlow[]
  aiAnalyses      AIAnalysis[]
  
  @@index([siteId])
  @@index([status])
  @@index([createdAt])
}

// Para Nasıl Akıyor? - Financial Flow Data
model FinancialFlow {
  id              String      @id @default(cuid())
  siteId          String
  dataUploadId    String?
  date            DateTime    // Tarih
  totalIncome     Float       @default(0)  // Toplam Gelir
  bankFees        Float       @default(0)  // Banka Kesintisi
  withdrawals     Float       @default(0)  // Çekim
  operatingCosts  Float       @default(0)  // İşletme Gideri
  netProfit       Float       @default(0)  // Net Kazanç (hesaplanmış)
  cumulativeProfit Float      @default(0)  // Kümülatif Kazanç
  month           String      // YYYY-MM format
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  site            Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)
  dataUpload      DataUpload?  @relation(fields: [dataUploadId], references: [id], onDelete: SetNull)
  
  @@unique([siteId, date])
  @@index([siteId, month])
  @@index([date])
}

// AI Analyst - Yapay Zeka Analiz Raporları
model AIAnalysis {
  id              String      @id @default(cuid())
  siteId          String
  dataUploadId    String?
  analyticModule  AnalyticModule
  analysisDate    DateTime    @default(now())
  prompt          String      @db.Text  // LLM'e gönderilen prompt
  response        String      @db.Text  // LLM'den gelen analiz
  tokensUsed      Int?        // Kullanılan token sayısı
  model           String      @default("gpt-4") // Kullanılan AI model
  isPublished     Boolean     @default(false) // Ana sayfada gösterilsin mi?
  createdAt       DateTime    @default(now())
  
  site            Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  dataUpload      DataUpload? @relation(fields: [dataUploadId], references: [id], onDelete: SetNull)
  
  @@index([siteId])
  @@index([analyticModule])
  @@index([isPublished])
  @@index([createdAt])
}

// Duyuru Sistemi - Announcement System
enum AnnouncementSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AnnouncementTargetType {
  ALL             // Tüm kullanıcılar
  ADMIN_ONLY      // Sadece adminler
  STAFF_ONLY      // Sadece personel
  SITE_SPECIFIC   // Belirli site
  DEPARTMENT_SPECIFIC  // Belirli birim
  ROLE_SPECIFIC   // Belirli rol
}

enum DisplayMode {
  ONCE            // Bir kez göster
  EVERY_LOGIN     // Her giriş
  DAILY           // Günlük
}

model Announcement {
  id              String                  @id @default(cuid())
  title           String
  content         String                  @db.Text
  severity        AnnouncementSeverity    @default(INFO)
  targetType      AnnouncementTargetType  @default(ALL)
  
  // Hedef filtreleme
  targetSiteId       String?              // Sadece bu site için (null = tüm siteler)
  targetDepartmentId String?              // Sadece bu birim için (null = tüm birimler)
  targetRole         UserRole?            // Sadece bu rol için (null = tüm roller)
  
  // Görüntüleme ayarları
  showAsPopup     Boolean                 @default(false)  // Ana sayfada popup olarak çıksın mı?
  displayMode     DisplayMode             @default(ONCE)   // Gösterim modu
  activeDays      String[]                @default([])     // Aktif günler: ["Pzt", "Sal", "Car", "Per", "Cum", "Cmt", "Paz"]
  removeOnRead    Boolean                 @default(true)   // Okunduğunda kaldırılsın mı?
  
  // Geçerlilik
  isActive        Boolean                 @default(true)
  expiresAt       DateTime?               // Son kullanma tarihi
  
  // Meta
  createdByUserId String
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  
  // İlişkiler
  targetSite      Site?                   @relation("AnnouncementTargetSite", fields: [targetSiteId], references: [id], onDelete: Cascade)
  targetDepartment Department?            @relation("AnnouncementTargetDepartment", fields: [targetDepartmentId], references: [id], onDelete: Cascade)
  readRecords     AnnouncementRead[]
  
  @@index([isActive])
  @@index([targetType])
  @@index([targetSiteId])
  @@index([targetDepartmentId])
  @@index([createdAt])
}

// Duyuru okunma kaydı
model AnnouncementRead {
  id              String       @id @default(cuid())
  announcementId  String
  userId          String
  readAt          DateTime     @default(now())
  
  announcement    Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@index([readAt])
}

// Kullanıcı bildirim tercihleri
model UserNotificationPreference {
  userId                    String   @id
  disableInfoNotifications  Boolean  @default(false)  // Bilgi bildirimleri kapalı
  disableWarningNotifications Boolean @default(false) // Uyarı bildirimleri kapalı
  disablePopups             Boolean  @default(false)  // Popup'ları kapat
  updatedAt                 DateTime @updatedAt
}

// Talep Sistemi - Request System

// Talep Türleri
enum RequestType {
  LEAVE        // İzin talebi
  OVERTIME     // Mesai talebi
  ADVANCE      // Avans talebi
}

// Talep Durumu
enum RequestStatus {
  PENDING      // Beklemede
  APPROVED     // Onaylandı
  REJECTED     // Reddedildi
  CANCELLED    // İptal edildi
}

// İzin/Mesai Türleri
enum LeaveType {
  ANNUAL       // Yıllık izin
  SICK         // Sağlık izni
  PERSONAL     // Kişisel izin
  OVERTIME     // Mesai
}

// Ana Talep Modeli
model Request {
  id                String        @id @default(cuid())
  type              RequestType
  status            RequestStatus @default(PENDING)
  
  // Talep eden kişi
  requestedById     String
  requestedBy       User          @relation("RequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  
  // Onaylayacak kişi (Birim Müdürü veya Finans Müdürü)
  approverId        String?
  approver          User?         @relation("Approver", fields: [approverId], references: [id], onDelete: SetNull)
  
  // Onay/Red bilgileri
  approvedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?       @db.Text
  
  // Genel bilgiler
  reason            String        @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Alt detaylar (polymorphic ilişki)
  leaveRequest      LeaveRequest?
  advanceRequest    AdvanceRequest?
  
  @@index([requestedById])
  @@index([approverId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// İzin/Mesai Talebi Detayları
model LeaveRequest {
  id          String    @id @default(cuid())
  requestId   String    @unique
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  leaveType   LeaveType
  startDate   DateTime  // Başlangıç tarihi
  endDate     DateTime  // Bitiş tarihi
  days        Int       // Gün sayısı
  
  // Mesai takvimine otomatik yansıtma için
  isReflectedToCalendar Boolean @default(false)
  reflectedAt           DateTime?
  
  createdAt   DateTime  @default(now())
  
  @@index([requestId])
  @@index([startDate])
}

// Avans Talebi Detayları
model AdvanceRequest {
  id          String    @id @default(cuid())
  requestId   String    @unique
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  amount      Float     // Talep edilen miktar
  userSalary  Float     // Kullanıcının kayıtlı maaşı (kontrol için)
  
  // Ödeme bilgileri (onaylandıysa)
  isPaid      Boolean   @default(false)
  paidAt      DateTime?
  paidBy      String?   // Ödemeyi yapan kişi
  
  createdAt   DateTime  @default(now())
  
  @@index([requestId])
}

// Kullanıcı maaş bilgisi (Avans kontrolü için)
model UserSalary {
  id          String    @id @default(cuid())
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  monthlySalary Float   // Aylık maaş
  currency      String  @default("TRY")
  
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())
  
  @@index([userId])
}

