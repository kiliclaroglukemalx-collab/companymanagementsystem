generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

model Site {
  id             String          @id @default(cuid())
  name           String          @unique
  users          User[]
  departments    Department[]
  securityEvents SecurityEvent[]
  trustedIps     TrustedIp[]
  arenaEvents    ArenaEvent[]
  ratings        Rating[]
  createdAt      DateTime        @default(now())
}

model Department {
  id             String           @id @default(cuid())
  siteId         String
  name           String
  site           Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  users          User[]
  ratingCriteria RatingCriteria[]
  ratings        Rating[]
  createdAt      DateTime         @default(now())

  @@unique([siteId, name])
  @@index([siteId])
}

model User {
  id                 String   @id @default(cuid())
  siteId             String
  departmentId       String?
  role               UserRole @default(STAFF)
  name               String
  email              String   @unique
  avatarKey          String?
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true)
  createdByUserId    String?

  site       Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  createdBy    User?  @relation("UserCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdUsers User[] @relation("UserCreatedBy")

  passwordCredential PasswordCredential?
  security           UserSecurity?
  sessions           Session[]
  securityEvents     SecurityEvent[]
  ratingsGiven       Rating[]            @relation("RatingsGiven")
  ratingsReceived    Rating[]            @relation("RatingsReceived")
  createdAt          DateTime            @default(now())

  @@index([siteId])
  @@index([departmentId])
}

model PasswordCredential {
  userId        String   @id
  passwordHash  String
  passwordSetAt DateTime
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSecurity {
  userId                   String   @id
  twoFactorEnabled         Boolean  @default(false)
  twoFactorSecretEncrypted String?
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id                    String    @id @default(cuid())
  userId                String
  ip                    String
  deviceLabel           String?
  deviceFingerprintHash String
  createdAt             DateTime  @default(now())
  lastSeenAt            DateTime  @default(now())
  revokedAt             DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ip])
}

model SecurityEvent {
  id         String    @id @default(cuid())
  siteId     String
  userId     String?
  type       String
  metaJson   Json
  createdAt  DateTime  @default(now())
  resolvedAt DateTime?
  resolvedBy String?

  site Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([siteId])
  @@index([userId])
}

model TrustedIp {
  id         String   @id @default(cuid())
  siteId     String
  ipCidrOrIp String
  note       String?
  createdAt  DateTime @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
}

model RatingCriteria {
  id           String        @id @default(cuid())
  departmentId String
  name         String
  weight       Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  department   Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  ratingScores RatingScore[]

  @@unique([departmentId, name])
  @@index([departmentId])
}

// Günlük puanlama kaydı
model Rating {
  id           String        @id @default(cuid())
  siteId       String
  departmentId String
  raterUserId  String        // Puan veren
  ratedUserId  String        // Puan alan
  date         String        // YYYY-MM-DD format
  totalScore   Float?        // Toplam puan (hesaplanmış)
  createdAt    DateTime      @default(now())

  site         Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  department   Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  rater        User          @relation("RatingsGiven", fields: [raterUserId], references: [id], onDelete: Cascade)
  rated        User          @relation("RatingsReceived", fields: [ratedUserId], references: [id], onDelete: Cascade)
  scores       RatingScore[]

  @@unique([raterUserId, ratedUserId, date]) // Aynı gün aynı kişiyi 2 kere puanlayamaz
  @@index([siteId])
  @@index([departmentId])
  @@index([date])
  @@index([ratedUserId])
}

// Kriter bazlı puanlar
model RatingScore {
  id         String   @id @default(cuid())
  ratingId   String
  criteriaId String
  score      Int      // 1-10 arası
  createdAt  DateTime @default(now())

  rating   Rating         @relation(fields: [ratingId], references: [id], onDelete: Cascade)
  criteria RatingCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  @@index([ratingId])
  @@index([criteriaId])
}

// Arena Live Feed Events
enum ArenaEventType {
  RATING_GIVEN
  LEADER_CHANGED
  RATING_PROGRESS
  SECURITY_ALERT
  USER_CREATED
  USER_JOINED
}

model ArenaEvent {
  id        String         @id @default(cuid())
  siteId    String
  type      ArenaEventType
  title     String
  message   String?
  metaJson  Json?
  createdAt DateTime       @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId, createdAt(sort: Desc)])
  @@index([type])
}
