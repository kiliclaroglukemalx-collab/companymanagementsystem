{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/Desktop/companymanagementsystem/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport type { NextRequest } from \"next/server\"\nimport { jwtVerify } from \"jose\"\n\nconst AUTH_COOKIE = \"cms-auth\"\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl\n  const isLoginRoute = pathname === \"/login\"\n  const isNextAsset = pathname.startsWith(\"/_next\")\n  const isPublicFile = /\\.[^/]+$/.test(pathname)\n  const isLoginApiRoute = pathname === \"/api/auth/login\"\n  const isLegacyLoginRoute = pathname === \"/api/login\"\n  const isFirstPasswordRoute = pathname === \"/api/auth/first-password\"\n  const isApiRoute = pathname.startsWith(\"/api\")\n\n  if (\n    isNextAsset ||\n    isPublicFile ||\n    isLoginApiRoute ||\n    isLegacyLoginRoute ||\n    isFirstPasswordRoute\n  ) {\n    return NextResponse.next()\n  }\n\n  const token = request.cookies.get(AUTH_COOKIE)?.value\n  const secret = process.env.AUTH_SECRET_KEY\n  let authPayload: { siteId: string; role: string; userId?: string; sessionId?: string } | null = null\n\n  if (token && secret) {\n    try {\n      const { payload } = await jwtVerify(token, new TextEncoder().encode(secret))\n      const siteId = payload.siteId\n      const role = payload.role\n      const userId = payload.sub\n      const sessionId = payload.sid\n      if (typeof siteId === \"string\" && typeof role === \"string\") {\n        authPayload = {\n          siteId,\n          role,\n          userId: typeof userId === \"string\" ? userId : undefined,\n          sessionId: typeof sessionId === \"string\" ? sessionId : undefined,\n        }\n      }\n    } catch {\n      authPayload = null\n    }\n  }\n\n  const isAuthed = Boolean(authPayload)\n  const isGuardRoute = pathname === \"/guard\"\n\n  // Guard route herkese açık\n  if (isGuardRoute) {\n    return NextResponse.next()\n  }\n\n  // Login olan kullanıcı /login veya /guard'a giderse anasayfaya yönlendir\n  if ((isLoginRoute || isGuardRoute) && isAuthed) {\n    const url = request.nextUrl.clone()\n    url.pathname = \"/\"\n    return NextResponse.redirect(url)\n  }\n\n  // Login olmayan kullanıcı /login dışında bir yere giderse /guard'a yönlendir\n  if (!isLoginRoute && !isGuardRoute && !isAuthed) {\n    if (isApiRoute) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    const url = request.nextUrl.clone()\n    url.pathname = \"/guard\"\n    return NextResponse.redirect(url)\n  }\n\n  if (authPayload) {\n    const requestHeaders = new Headers(request.headers)\n    requestHeaders.set(\"x-site-id\", authPayload.siteId)\n    requestHeaders.set(\"x-user-role\", authPayload.role)\n    if (authPayload.userId) {\n      requestHeaders.set(\"x-user-id\", authPayload.userId)\n    }\n    if (authPayload.sessionId) {\n      requestHeaders.set(\"x-session-id\", authPayload.sessionId)\n    }\n    return NextResponse.next({ request: { headers: requestHeaders } })\n  }\n\n  return NextResponse.next()\n}\n\n// Tüm sayfaları şifre kalkanı altına alıyoruz\nexport const config = {\n  matcher: \"/:path*\",\n}"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;;;AAEA,MAAM,cAAc;AAEb,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IACpC,MAAM,eAAe,aAAa;IAClC,MAAM,cAAc,SAAS,UAAU,CAAC;IACxC,MAAM,eAAe,WAAW,IAAI,CAAC;IACrC,MAAM,kBAAkB,aAAa;IACrC,MAAM,qBAAqB,aAAa;IACxC,MAAM,uBAAuB,aAAa;IAC1C,MAAM,aAAa,SAAS,UAAU,CAAC;IAEvC,IACE,eACA,gBACA,mBACA,sBACA,sBACA;QACA,OAAO,sOAAY,CAAC,IAAI;IAC1B;IAEA,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,cAAc;IAChD,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe;IAC1C,IAAI,cAA4F;IAEhG,IAAI,SAAS,QAAQ;QACnB,IAAI;YACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,kNAAS,EAAC,OAAO,IAAI,cAAc,MAAM,CAAC;YACpE,MAAM,SAAS,QAAQ,MAAM;YAC7B,MAAM,OAAO,QAAQ,IAAI;YACzB,MAAM,SAAS,QAAQ,GAAG;YAC1B,MAAM,YAAY,QAAQ,GAAG;YAC7B,IAAI,OAAO,WAAW,YAAY,OAAO,SAAS,UAAU;gBAC1D,cAAc;oBACZ;oBACA;oBACA,QAAQ,OAAO,WAAW,WAAW,SAAS;oBAC9C,WAAW,OAAO,cAAc,WAAW,YAAY;gBACzD;YACF;QACF,EAAE,OAAM;YACN,cAAc;QAChB;IACF;IAEA,MAAM,WAAW,QAAQ;IACzB,MAAM,eAAe,aAAa;IAElC,2BAA2B;IAC3B,IAAI,cAAc;QAChB,OAAO,sOAAY,CAAC,IAAI;IAC1B;IAEA,yEAAyE;IACzE,IAAI,CAAC,gBAAgB,YAAY,KAAK,UAAU;QAC9C,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,OAAO,sOAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,6EAA6E;IAC7E,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,UAAU;QAC/C,IAAI,YAAY;YACd,OAAO,sOAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QACA,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,OAAO,sOAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,aAAa;QACf,MAAM,iBAAiB,IAAI,QAAQ,QAAQ,OAAO;QAClD,eAAe,GAAG,CAAC,aAAa,YAAY,MAAM;QAClD,eAAe,GAAG,CAAC,eAAe,YAAY,IAAI;QAClD,IAAI,YAAY,MAAM,EAAE;YACtB,eAAe,GAAG,CAAC,aAAa,YAAY,MAAM;QACpD;QACA,IAAI,YAAY,SAAS,EAAE;YACzB,eAAe,GAAG,CAAC,gBAAgB,YAAY,SAAS;QAC1D;QACA,OAAO,sOAAY,CAAC,IAAI,CAAC;YAAE,SAAS;gBAAE,SAAS;YAAe;QAAE;IAClE;IAEA,OAAO,sOAAY,CAAC,IAAI;AAC1B;AAGO,MAAM,SAAS;IACpB,SAAS;AACX"}}]
}